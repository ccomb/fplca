module Views.ActivitiesView exposing (viewActivitiesPage, Msg(..))

import Html exposing (Html, button, div, input, option, select, table, tbody, text, th, thead, tr, h2, p, span)
import Html.Attributes exposing (class, placeholder, style, value, type_, disabled, selected)
import Html.Events exposing (onInput, onClick)
import Models.Activity exposing (ActivitySummary, SearchResults)
import Models.Database exposing (DatabaseList, DatabaseStatus)
import Views.ActivityRow as ActivityRow


type Msg
    = UpdateSearchQuery String
    | SelectActivity String
    | LoadMore
    | ActivateDatabase String


viewActivitiesPage : String -> Maybe (SearchResults ActivitySummary) -> Bool -> Bool -> Maybe String -> Maybe DatabaseList -> Html Msg
viewActivitiesPage searchQuery searchResults searchLoading loadingMore error maybeDatabaseList =
    div [ class "activities-page", style "display" "flex", style "flex-direction" "column", style "height" "100%" ]
        [ div [ class "box", style "margin-bottom" "0", style "flex-shrink" "0" ]
            [ h2 [ class "title is-3" ] [ text "Search Activities" ]
            , p [ class "subtitle" ] [ text "Find activities by name and view their environmental inventory" ]
            , viewSearchBar maybeDatabaseList searchQuery searchLoading
            , case error of
                Just err ->
                    div [ class "notification is-danger" ]
                        [ text ("Error: " ++ err) ]

                Nothing ->
                    text ""
            ]
        , viewSearchResults searchResults searchLoading loadingMore
        ]


viewSearchBar : Maybe DatabaseList -> String -> Bool -> Html Msg
viewSearchBar maybeDatabaseList query isLoading =
    div [ class "field is-grouped", style "margin-bottom" "1.5rem" ]
        [ -- Database selector on the left
          case maybeDatabaseList of
            Nothing ->
                text ""

            Just dbList ->
                let
                    loadedDatabases =
                        List.filter .loaded dbList.databases

                    currentDbName =
                        dbList.current |> Maybe.withDefault ""
                in
                div [ class "control" ]
                    [ div [ class "select is-large" ]
                        [ select
                            [ onInput ActivateDatabase ]
                            (List.map (viewDatabaseOption currentDbName) loadedDatabases)
                        ]
                    ]
        , -- Search input on the right (expanded)
          div [ class "control has-icons-left is-expanded", class (if isLoading then "is-loading" else "") ]
            [ input
                [ class "input is-large"
                , type_ "text"
                , placeholder "Search activities by name..."
                , value query
                , onInput UpdateSearchQuery
                , disabled isLoading
                ]
                []
            , span [ class "icon is-left" ]
                [ Html.i [ class "fas fa-search" ] []
                ]
            ]
        ]


viewSearchResults : Maybe (SearchResults ActivitySummary) -> Bool -> Bool -> Html Msg
viewSearchResults maybeResults isLoading loadingMore =
    case ( isLoading, maybeResults ) of
        ( True, Nothing ) ->
            div [ class "has-text-centered" ]
                [ div [ class "is-size-5 has-text-grey" ] [ text "Searching..." ]
                ]

        ( _, Nothing ) ->
            text ""

        ( _, Just results ) ->
            if List.isEmpty results.results then
                div [ class "has-text-centered" ]
                    [ div [ class "is-size-5 has-text-grey" ] [ text "No activities found" ]
                    ]
            else
                div [ style "flex" "1", style "display" "flex", style "flex-direction" "column", style "min-height" "0" ]
                    [ div [ style "flex-shrink" "0", style "padding" "0.5rem 0" ]
                        [ span [ class "tag is-info is-light" ]
                            [ text (String.fromInt (List.length results.results) ++ " / " ++ String.fromInt results.totalCount ++ " activities")
                            ]
                        ]
                    , div [ style "flex" "1", style "overflow-y" "auto", style "min-height" "0" ]
                        [ table [ class "table is-striped is-hoverable is-fullwidth" ]
                            [ thead [ style "position" "sticky", style "top" "0", style "background-color" "white", style "z-index" "10" ]
                                [ tr []
                                    [ th [ style "background-color" "white" ] [ text "Activity Name" ]
                                    , th [ style "background-color" "white" ] [ text "Product" ]
                                    , th [ style "background-color" "white" ] [ text "Location" ]
                                    ]
                                ]
                            , tbody []
                                (List.map viewActivityRow results.results)
                            ]
                        ]
                    , if results.hasMore then
                        div [ class "has-text-centered", style "flex-shrink" "0", style "padding" "1rem 0" ]
                            [ button
                                [ class (if loadingMore then "button is-primary is-loading" else "button is-primary")
                                , onClick LoadMore
                                , disabled loadingMore
                                ]
                                [ text "Load more" ]
                            ]
                      else
                        text ""
                    ]


viewActivityRow : ActivitySummary -> Html Msg
viewActivityRow activity =
    ActivityRow.viewActivityRow
        { id = Just activity.id
        , name = activity.name
        , product = activity.product
        , location = activity.location
        , quantity = Nothing
        , onNavigate = SelectActivity
        }


viewDatabaseOption : String -> DatabaseStatus -> Html Msg
viewDatabaseOption currentDbName db =
    option
        [ value db.name
        , selected (db.name == currentDbName)
        ]
        [ text db.displayName ]